#!/usr/bin/env python
from __future__ import print_function
import argparse
import os

from pprint import pprint
from subprocess import call, Popen, STDOUT, PIPE
from sys import exit

pt = lambda x,y: print("\033[%sm%s\033[0m" % (30 + x,y)) # Where 0 <= x <= 7

parser = argparse.ArgumentParser(description="Super testing suite for MilliC")
parser.add_argument('directory', help="Which test directory to use e.g. 'base'. Use '.' for all tests")
parser.add_argument('--nomillic', help='Disables makefile error messages', action="store_true")
parser.add_argument('--nogcc', help="Does full compile but no running", action="store_true")
parser.add_argument('--noclean', help='Disable cleanup post run', action="store_true")
parser.add_argument('--nopass', help="Disables showing passing test cases", action='store_true')
parser.add_argument('--nofail', help="Disables showing failing test cases", action='store_true')

flags = parser.parse_args()

microcpath = os.getcwd() + "/microc"

def getTestPaths():
    allPaths = []
    current = os.getcwd()
    print(current)
    for tup in os.walk('./tests'):
        for test in tup[2]:
            allPaths.append(current + tup[0][1:] + '/' + test)
    allPaths = filter(lambda x: x[-2:] == 'mc', allPaths)
    allPaths = filter(lambda x: flags.directory in x, allPaths)
    return allPaths

def setup():
    show = False if flags.nomillic else True
    try:
        c = call(['make'])
        if c != 0:
            pt(1, "Makefile failed: Error Code %s" % c)
            exit()
    except Exception as e:
        pt(1, "Makefile failed:%s" % e)

def test(filepath):
    code = open(filepath).read().encode('ascii','ignore')
    try:
        p = Popen([microcpath,'-C'], stdin = PIPE, stdout = PIPE, stderr = STDOUT)
        out,err = p.communicate(input=code)
        if "error" in out and not flags.nofail:
            pt(1,"%s" % out)
            pt(3, code)
        elif not flags.nopass:
            pt(2, "%s PASSED" % filepath)
    except Exception as e:
        pt(3, "Failed MilliC %s:%s" % (filepath,e))
    if flags.nogcc:
        return
    try:
        target = 'gcc -o %s %s' % (filepath[filepath.rfind('/'):] + ".exe" , filepath)
        Popen([target], shell = True)
    except Exception as e:
        pt(3, "Failed GCC %s:%s" % (filepath,e))

if __name__ == "__main__":
    """
    Temporarily disabled gcc and pass cases
    """
    flags.nogcc = True
    setup() 
    for t in getTestPaths():
        test(t)
    if not flags.noclean:
        call(['make','clean'])
